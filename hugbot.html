<!-- åˆ›å»ºæ–°æ–‡ä»¶ï¼šhugbot.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HugBot - ä½ çš„æƒ…ç»ªé™ªä¼´ä¼™ä¼´</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #app {
            width: 100%;
            max-width: 400px;
            height: 90vh;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* èŠå¤©å®¹å™¨ */
        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            max-width: 80%;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .user-message {
            align-self: flex-end;
            background-color: #dcf8c6;
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: #f0f0f0;
        }
        
        #chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }
        
        #user-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        
        #send-btn {
            margin-left: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        
        /* æ‹¥æŠ±é‚€è¯· */
        #hug-invite {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .hug-card {
            background-color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .character {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .hug-buttons button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
        }
        
        #accept-hug {
            background-color: #FF6B6B;
            color: white;
        }
        
        /* ARå®¹å™¨ */
        #ar-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }
        
        #hug-timer {
            color: white;
            font-size: 20px;
            margin-bottom: 20px;
        }
        
        #end-hug {
            padding: 10px 20px;
            background-color: #FF6B6B;
            color: white;
            border: none;
            border-radius: 20px;
            margin-bottom: 30px;
            cursor: pointer;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="chat-container">
            <div id="chat-messages">
                <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            <div id="chat-input">
                <input type="text" id="user-input" placeholder="å‘Šè¯‰æˆ‘ä½ çš„å¿ƒæƒ…...">
                <button id="send-btn">å‘é€</button>
            </div>
        </div>
        
        <!-- ARæ‹¥æŠ±é‚€è¯·å¼¹çª—ï¼ˆåˆå§‹éšè—ï¼‰ -->
        <div id="hug-invite" class="hidden">
            <div class="hug-card">
                <div class="character">ğŸ¦Š</div>
                <p id="hug-message">å°ç‹æƒ³ç»™ä½ ä¸€ä¸ªæ¸©æš–çš„æ‹¥æŠ±~</p>
                <div class="hug-buttons">
                    <button id="accept-hug">æ¥å—æ‹¥æŠ±</button>
                    <button id="decline-hug">ç¨åå†èŠ</button>
                </div>
            </div>
        </div>
        
        <!-- ARåœºæ™¯å®¹å™¨ï¼ˆåˆå§‹éšè—ï¼‰ -->
        <div id="ar-container" class="hidden">
            <div id="hug-timer">æ‹¥æŠ±å‰©ä½™: 30ç§’</div>
            <button id="end-hug">æå‰ç»“æŸ</button>
        </div>
    </div>
    
    <script>
        // é…ç½®æƒ…ç»ªAPIç«¯ç‚¹ï¼ˆæ›¿æ¢ä¸ºä½ çš„Colab ngrok URLï¼‰
        const EMOTION_API_URL = "https://your-colab-ngrok-url";
        
        // DOMå…ƒç´ 
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const hugInvite = document.getElementById('hug-invite');
        const hugMessage = document.getElementById('hug-message');
        const acceptHugBtn = document.getElementById('accept-hug');
        const declineHugBtn = document.getElementById('decline-hug');
        const arContainer = document.getElementById('ar-container');
        const hugTimer = document.getElementById('hug-timer');
        const endHugBtn = document.getElementById('end-hug');
        
        // åˆå§‹åŒ–
        function init() {
            sendBtn.addEventListener('click', handleUserMessage);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleUserMessage();
            });
            
            acceptHugBtn.addEventListener('click', startARHug);
            declineHugBtn.addEventListener('click', () => {
                hugInvite.classList.add('hidden');
                addMessage("å¥½çš„ï¼Œéœ€è¦æ—¶éšæ—¶æ‰¾æˆ‘~", 'bot');
            });
            
            endHugBtn.addEventListener('click', endHugSession);
            
            // åˆå§‹æ¶ˆæ¯
            addMessage("ä½ å¥½ï¼æˆ‘æ˜¯å°ç‹ï¼Œéšæ—¶åœ¨è¿™é‡Œé™ªä¼´ä½ ã€‚æœ‰ä»€ä¹ˆæƒ³å’Œæˆ‘åˆ†äº«çš„å—ï¼Ÿ", 'bot');
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${sender}-message`);
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // å¤„ç†ç”¨æˆ·æ¶ˆæ¯
        async function handleUserMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            userInput.value = '';
            addMessage(message, 'user');
            
            // åˆ†ææƒ…ç»ª
            try {
                const emotionResult = await analyzeStress(message);
                console.log('æƒ…ç»ªåˆ†æç»“æœ:', emotionResult);
                
                if (emotionResult.stress_level > 0.7) {
                    // é«˜å‹åŠ›ï¼šæ˜¾ç¤ºæ‹¥æŠ±é‚€è¯·
                    showHugInvitation();
                } else {
                    // æ­£å¸¸ï¼šç”Ÿæˆå›åº”
                    const response = generateReply(emotionResult);
                    setTimeout(() => {
                        addMessage(response, 'bot');
                    }, 1000);
                }
            } catch (error) {
                console.error('æƒ…ç»ªåˆ†æå¤±è´¥:', error);
                addMessage("æˆ‘å¥½åƒå‡ºäº†ç‚¹å°é—®é¢˜ï¼Œè¯·å†è¯•ä¸€æ¬¡", 'bot');
            }
        }
        
        // æƒ…ç»ªåˆ†æAPIè°ƒç”¨
        async function analyzeStress(text) {
            const response = await fetch(`${EMOTION_API_URL}/analyze`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });
            
            if (!response.ok) {
                throw new Error(`APIé”™è¯¯: ${response.status}`);
            }
            
            return response.json();
        }
        
        // ç”Ÿæˆå›åº”
        function generateReply(emotionResult) {
            const replies = {
                high: [
                    "æˆ‘æ„Ÿå—åˆ°ä½ çš„å‹åŠ›äº†ï¼Œè¦å’Œæˆ‘èŠèŠå—ï¼Ÿ",
                    "è¿™å¬èµ·æ¥å¾ˆä¸å®¹æ˜“ï¼Œæˆ‘åœ¨è¿™é‡Œæ”¯æŒä½ ",
                    "å‹åŠ›å¤§çš„æ—¶å€™ï¼Œç»™è‡ªå·±ä¸€ç‚¹æ¸©æŸ”çš„ç©ºé—´"
                ],
                normal: [
                    "æ„Ÿè°¢åˆ†äº«ï¼Œç»§ç»­å‰è¿›å§ï¼",
                    "ä¿æŒç§¯æçš„å¿ƒæ€å¾ˆé‡è¦å“¦",
                    "æœ‰ä»€ä¹ˆæ–°çš„äº‹æƒ…æƒ³å’Œæˆ‘èŠèŠå—ï¼Ÿ"
                ]
            };
            
            const category = emotionResult.stress_level > 0.7 ? 'high' : 'normal';
            return replies[category][Math.floor(Math.random() * replies[category].length)];
        }
        
        // æ˜¾ç¤ºæ‹¥æŠ±é‚€è¯·
        function showHugInvitation() {
            // æ ¹æ®å‹åŠ›å€¼å®šåˆ¶æ¶ˆæ¯
            const messages = [
                "å°ç‹æ„Ÿå—åˆ°ä½ çš„å‹åŠ›ï¼Œæƒ³ç»™ä½ ä¸€ä¸ªæ¸©æš–çš„æ‹¥æŠ±",
                "ä½ å€¼å¾—è¢«å…³çˆ±ï¼Œè®©å°ç‹æŠ±æŠ±ä½ å§",
                "å‹åŠ›å¤§çš„æ—¶å€™ï¼Œä¸€ä¸ªæ‹¥æŠ±èƒ½æ²»æ„ˆå¿ƒçµ"
            ];
            hugMessage.textContent = messages[Math.floor(Math.random() * messages.length)];
            hugInvite.classList.remove('hidden');
        }
        
        // å¼€å§‹ARæ‹¥æŠ±
        function startARHug() {
            hugInvite.classList.add('hidden');
            arContainer.classList.remove('hidden');
            
            // å¯åŠ¨30ç§’å€’è®¡æ—¶
            let seconds = 30;
            hugTimer.textContent = `æ‹¥æŠ±å‰©ä½™: ${seconds}ç§’`;
            
            const timer = setInterval(() => {
                seconds--;
                hugTimer.textContent = `æ‹¥æŠ±å‰©ä½™: ${seconds}ç§’`;
                
                // æ¨¡æ‹Ÿè§¦è§‰åé¦ˆ
                if (seconds % 5 === 0) {
                    simulateHapticFeedback();
                }
                
                if (seconds <= 0) {
                    clearInterval(timer);
                    endHugSession();
                }
            }, 1000);
            
            // å­˜å‚¨è®¡æ—¶å™¨ä»¥ä¾¿æå‰ç»“æŸ
            window.hugTimer = timer;
        }
        
        // æ¨¡æ‹Ÿè§¦è§‰åé¦ˆ
        function simulateHapticFeedback() {
            if ('vibrate' in navigator) {
                navigator.vibrate([100, 50, 100]);
            } else {
                // æ¡Œé¢ç«¯æ¨¡æ‹Ÿæ•ˆæœ
                document.body.style.animation = 'pulse 0.3s';
                setTimeout(() => {
                    document.body.style.animation = '';
                }, 300);
            }
        }
        
        // ç»“æŸæ‹¥æŠ±
        function endHugSession() {
            clearInterval(window.hugTimer);
            arContainer.classList.add('hidden');
            
            // æ˜¾ç¤ºç»“æŸæ¶ˆæ¯
            addMessage("å¸Œæœ›è¿™ä¸ªæ‹¥æŠ±è®©ä½ æ„Ÿè§‰å¥½ä¸€äº›ï¼", 'bot');
            
            // æ·»åŠ æƒ…ç»ªè½¬åŒ–å¥–åŠ±
            addEmotionFlower();
        }
        
        // æ·»åŠ æƒ…ç»ªè½¬åŒ–èŠ±æœµ
        function addEmotionFlower() {
            const flowers = ["ğŸŒ¸", "ğŸŒ¼", "ğŸŒº", "ğŸŒ»", "ğŸŒ·"];
            const randomFlower = flowers[Math.floor(Math.random() * flowers.length)];
            
            setTimeout(() => {
                addMessage(`ä½ çš„å‹åŠ›å·²è½¬åŒ–ä¸ºä¸€æœµ${randomFlower}ï¼Œç»§ç»­åŠ æ²¹ï¼`, 'bot');
            }, 1000);
        }
        
        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', init);
    </script>
    
    <style>
        /* è§¦è§‰åé¦ˆåŠ¨ç”» */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.01); }
            100% { transform: scale(1); }
        }
    </style>
</body>
</html>
